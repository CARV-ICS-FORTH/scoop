% It doesnâ€™t do anything, per se, it just warns when you accidentally
% use deprecated LaTeX constructs from l2tabu
\RequirePackage[l2tabu, orthodox]{nag}

%% THis is to resolve error 131 in adobe reader
%\pdfobjcompresslevel=1

%\pdfminorversion=4
% Check https://en.wikibooks.org/wiki/LaTeX/Document_Structure for
% more info
\documentclass[
a4paper,
12pt,
]{article}

\input{preamble.tex}

\def\scoopversion{2.0.0}

\begin{document}

\begin{titlepage}
\begin{center}

  \vspace*{5cm}

  \LARGE \textbf{SCOOP v\scoopversion\\}
  Manual\\[0.5cm]
  \large \today

  \vfill

  \large Author:
  {\textit{Foivos S. Zakkak}}\\
  \href{mailto:zakkak@ics.forth.gr}{\textit{zakkak@ics.forth.gr}}\\[1cm]

  Foundation for Research and Technology - Hellas (FORTH)\\
  Institute of Computer Science\\
  N. Plastira 100\\
  Vassilika Vouton, GR-700 13 Heraklion, Crete, Greece\\[0.5cm]

\end{center}

\end{titlepage}

\pagenumbering{Roman}
\pagestyle{plain}

\section*{License}

\begin{verbatim}
Copyright (c) 2010-13,
                       Foivos   Zakkak     <zakkak@ics.forth.gr>
                       Dimitris Chassapis  <polyvios@ics.forth.gr>
                       Polyvios Pratikakis <polyvios@ics.forth.gr>


                       FORTH-ICS / CARV
                       (Foundation for Research & Technology -- Hellas,
                        Institute of Computer Science,
                        Computer Architecture & VLSI Systems Laboratory)


Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
\end{verbatim}

\newpage
\tableofcontents{}
\newpage
\pagenumbering{arabic}
\pagestyle{headings}

\section{Annotation Syntax}

    \verb!  #pragma scoop start(list of variables)!\\
    \verb!  #pragma scoop finish!\\
    \verb!  #pragma scoop malloc!\\
    \verb!  #pragma scoop free!\\
    \verb!  #pragma scoop sync!\\
    \verb!  #pragma scoop barrier!\\
    \verb!  #pragma scoop wait all!\\
    \verb!  #pragma scoop wait on(list of variables)!\\
    \verb!  #pragma scoop task [in(<input parameters>)]!\\
    \verb!                     [inout(<input parameters>)]!\\
    \verb!                     [out(<input parameters>)]!\\[1em]

    Parameter notation:\\

      Non stride: \ \verb!<parameter>[\[number of elements (for arrays)\]]!
      %% \footnote{XPPFX and nesting require the size in bytes and not in
      %%   elements}
      \\

      Stride: \ \ \ \ \ \ \ \verb!<parameter>\[Block Rows|Block Columns\]\[[Array Rows|]Array Columns\]!\\
        \hspace{2cm}Array Rows is optional and is totally ignored\\

      %% Stride (Legacy): \ \ \ \ \ \ \ \verb!<parameter>\[stride\]\[ els | elsz \]!\\
      %%   \hspace{2cm}where stride is the step (original row length)\\
      %%   \hspace{2cm}els is the block's number of rows\\
      %%   \hspace{2cm}elsz is the block's row length\\

      The parameter size/stride/els/elsz must be an expression, thus
      we don't allow function calls. Also there is no support for the
      conditional operator (? :)\\

    Example:
      \verb!#pragma scoop task in(a, b[4]) out(c[16])!


\section{Installing}

This section describes how to install SCOOP on your system.  We
suppose that you have checked out/cloned SCOOP under \verb!/opt/scoop!
directory.  However the same instructions should apply for any
alternative path, simply replacing \verb!/opt/scoop! with the desired
alternative path for the rest of this section.

\subsection{Dependencies}

In order to build SCOOP you will need to install the following
packages:

\begin{itemize}
  \setlength{\itemsep}{1pt}
  \setlength{\parskip}{0pt}
  \setlength{\parsep}{0pt}
  \item ocaml $>=$ 3.11.2
  \item camlp4/ocaml-camlp4/ocaml-camlp4-devel
  \item flex
  \item bison
  \item indent
  \item ncurses-devel
  \item emacs
  \item gperf
\end{itemize}

%% \begin{tabbing}
%% for \emph{CELL B.E} runtimes you will also need the cell development package
%% including ppu\_intrinsics.h,\\ altivec.h etc in your include path
%% (C\_INCLUDE\_PATH)\\
%%   (e.g. \=\verb!export C_INCLUDE_PATH=$C_INCLUDE_PATH:/opt/cell/toolchain/lib/gcc/ppu/4.1.1/include!\\
%%    \>\verb!export C_INCLUDE_PATH=$C_INCLUDE_PATH:/opt/cell/toolchain/lib/gcc/spu/4.1.1/include!)\\
%%   and ppu32-gcc in your PATH\\
%%   (e.g. \verb!export PATH=$PATH:/opt/cell/toolchain/bin!)\\
%% \end{tabbing}

\subsection{Compile}
To compile SCOOP you have to run \verb!configure! and then \verb!make!.
\begin{bash}
  ./configure && make
\end{bash}

\subsection{Install}
You can install SCOOP running
\begin{bash}
  sudo make install
\end{bash}
this will create a copy of the scoop executable in
\verb!/usr/local/bin!.\\
\textbf{NOTE}: You still have to keep the current directory to your system.

Alternatively you can append \verb!/opt/scoop! to the \verb!PATH!
variable.\\
i.e.
\begin{bash}
  echo "export PATH=$PATH:/opt/scoop" >> $HOME/.bashrc
\end{bash}

\subsection{Uninstall}

You can uninstall SCOOP running
\begin{bash}
  sudo make uninstall
\end{bash}
this will erase the copy of the scoop executable from
\verb!/usr/local/bin!.

If you chose the alternative method of adding \verb!/opt/scoop! to
your \verb!PATH! variable, simply remove the added line from your \verb!.bashrc!

\section{Usage}

\begin{bash}
  scoop --runtime=<myrmics/dummy> [options] <file> [file2 ...]
\end{bash}

\subsection{Options}

  \begin{tabbing}
  \ \ \=\verb!--runtime!\hspace{4em} \=Define the target runtime/architecture\\
                                    \>\>myrmics $|$ dummy\\[1ex]
  \>\verb!--cflags!                   \>Defines the flags you want to pass to gcc\\[1ex]
  \>\verb!--include-path!             \>Defines the path containing the runtime header files.\\[1ex]
  \>\verb!--debug-SCOOP!              \>Print debugging information\\[1ex]
  \>\verb!--trace!                    \>Trace SCOOP\\[1ex]
  \>\verb!--out-name!                 \>Specify the output files' prefix. e.g. (default: scoop\_trans)\\
                                    \>\>will produce scoop\_trans.c\\[1ex]
  \>\verb!--pragma!                   \>Specify the string constant following the pragma e.g.\\
                                    \>\>(default: runtime's name). For myrmics will recognise\\
                                    \>\>\verb!#pragma myrmics!\\[1ex]
  \>\verb!--disable-sdam!             \>Disable the static dependence analysis module
  \end{tabbing}

\section{Extending SCOOP}

In order to add support for your runtime on the SCOOP compiler you
have to take the following steps.

\begin{enumerate}
  \item copy src/scoop\_dummy.ml and src/scoop\_dummy.mli to
    src/scoop\_myruntime.ml and src/scoop\_myruntime.mli respectively.
  \item append scoop\_myruntime to the SCOOP\_MODULES variable in
    Makefile.
  \item Perform any required changes to src/scoop\_myruntime.ml
  \item Append \verb!Scoop_myruntime.options! to \verb!fd_extraopt! in
    src/scoop.ml
  \item Add the following lines to \verb~match !arch with~ in src/scoop.ml\\
    \verb~| "myruntime" ->~\\
    \verb~  new Scoop_myruntime.codegen callgraph !gen_file !pragma_str !includePath~
\end{enumerate}

\section{Common Errors/Limitations/Known Bugs}

\begin{itemize}
\item Adding a semicolon at the end of \verb!#pragma!s will make SCOOP fail\\
  i.e. \verb!#pragma scoop sync;!
\item Putting \verb!#pragma scoop barrier! at the end of a block will make SCOOP fail\\
  (add a semicolon right below the \verb!#pragma! to fix it).
\item \textbf{{Fatal error: exception Invalid\_argument("Unknown")}}
  you probably have wrong argument at a call tagged with
  \verb!#pragma scoop task!
\item Using DEFINES or MACROS in pragmas (preprocessor doesn't process
  them)
\item Putting \verb!#pragma!s directly above a declaration of a
  variable (pragmas are only supported above statements)
\item Using directly the runtime API instead of the corresponging
  \verb!#pragma! may result in SDAM not working properly.
\item \textbf{Error: "segment\_\_\_0" not found in the \#pragma scoop
    task} usually means that the tool is renaming a variable due to
  previous declaration try renaming it manually (e.g. segment2) (This
  should be fixed by now)
\end{itemize}

\end{document}
